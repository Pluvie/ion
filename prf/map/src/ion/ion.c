#include "../../../../src/ion.h"
#include "../../../../src/ion.c"

extern i32 numbers[];

void map_inspect(struct map* map) {
  for (i32 i = 0; i < map->capacity + MAP_PADDED_CAP; i++) {
    void* entry = map->entries + (i * map->entry_typesize);
    i32 key = as(i32, map_entry_key(map, entry));
    i32 value = as(i32, map_entry_value(map, entry));

    if (map_entry_is_empty(map, entry)) {
      print("index: %u,--", i);
    } else {
      print("index: %u, key: %u, value: %u", i, key, value);
    }
  }
}

void insert (
    void
)
{
  struct memory allocator = memory_init(0);
  struct map* map = map_allocate(sizeof(i32), sizeof(i32), 0, &allocator);

  for (i32 i = 0; i < 1000000; i++) {
    map_set(map, &i, &i);
  }

  print("Done: %i", as(i32, map_get(map, &(i32) { 999999 })));
  memory_release(&allocator);
}

void lookup (
    void
)
{
  struct memory allocator = memory_init(0);
  struct map* map = map_allocate(sizeof(i32), sizeof(i32), 0, &allocator);

  for (i32 i = 0; i < 1000; i++) {
    map_set(map, &numbers[i], &i);
  }

  i32 v;
  for (i32 j = 0; j < 10000; j++) {
    for (i32 i = 0; i < 1000; i++) {
      v = as(i32, map_get(map, &numbers[i]));
    }
  }

  print("Size: %li", map->length);
  print("LF: %f", (d64) map->length / (d64) map->capacity);
  print("Buckets: %li", map->capacity);
  print("Done: %i", v);
  //map_inspect(map);
  memory_release(&allocator);
}

i32 main (
    i32 argc,
    char** argv
)
{
  insert();
  lookup();
  return EXIT_SUCCESS;
}

i32 numbers[] = {
 660243, 183487, 349829, 723521, 869182, 855900, 631825, 762097,  88760, 877229, 211180,
 184250, 938476, 879995, 478638, 941064,  95831, 106271, 585635, 900241, 636978, 819282,
 200357, 744761, 704975, 984066, 361726, 417089, 342256, 173680, 709161, 951830, 120277,
 197055, 842842, 879099,  79074, 472161, 685703, 110006, 843463, 844600, 203721, 367444,
 992522, 703424, 147567, 561007, 231528, 937046, 604483, 599457, 323364, 679756, 958049,
 353621, 596957, 178165, 127350, 194150, 285378, 100326, 783774, 959175, 554604, 535490,
 688312, 164371, 251316, 738268, 123275, 530756, 948588, 585852, 985227, 526543, 326771,
 603906, 856071, 311220, 357270, 107263, 290347, 155149, 462177, 699962, 127488, 272961,
 470349, 160484, 767206,  14026, 638752, 743446,  20686, 672881, 845817, 681000,  16312,
 342119, 520645, 133354, 537395, 260307, 779341, 343023, 919691,  12602, 640850, 728981,
 108031, 920202, 885495, 802510, 181888, 695524, 598140, 122149, 980020, 723690, 860635,
 276764, 524585, 521877, 238748, 301927, 202253, 790213, 286350, 560047, 938803, 112892,
 323651, 439432, 111541,  97242, 177767, 135111, 778045, 652664, 794157, 174060, 876613,
 606185, 139514,  39272, 437283, 540010,  28717, 787857, 424484,  82409, 460002, 508675,
 624118, 850425, 820075, 427808, 592097, 786018, 205573, 782660, 142690, 992259, 999530,
 785808, 325140,  78651, 862321, 551868, 749029, 895521, 441472,  22551, 545002, 639304,
 945657, 159734, 108397, 143749, 722118, 458183, 455248, 866284, 963974, 539809, 896092,
 927225, 416789, 338099, 676904,  19791, 957258, 555573, 506463, 149253,   7474, 192252,
 754902, 825134, 865928, 399947, 456640, 629632, 717680, 788454, 230942, 982077, 246743,
 551785, 463169, 380198, 849653, 643525, 734956, 882806, 990911, 421003,  75544, 301355,
 162941, 993143, 566105, 691056, 774729, 702219, 949400, 985407, 897852, 636048, 586417,
 731272, 893162, 341026, 971846, 529806, 496048, 534365, 961211, 219458, 124541, 399359,
 436773, 260610, 937259, 785911, 244109, 353827, 840889, 100178, 311844, 997716, 920448,
 889274, 546357, 306727, 752437, 335111, 573980, 971186, 371744, 227552,  25496, 294371,
 731109, 367965, 482532, 766428, 798145, 217798, 997054, 785962, 537374, 891934, 487579,
 236222, 473750, 800542, 233524, 562608, 230721, 625012, 203024, 430462, 871007, 714306,
 329490, 379535, 301038, 493663, 582614, 879254, 687661, 555528, 562816, 178819, 697284,
 736037, 321806, 153978, 643374, 528526, 958282, 996633, 468487, 631157, 305355,  14483,
 268962, 848846, 265580, 197267, 372899, 804023,  86685, 233131, 952908, 491012,  71148,
 364878,  76206, 458216, 989655, 554687, 971795, 961773, 766996, 423214, 727382, 368168,
 652048, 326896, 772000, 873865,  57587, 804646, 740412, 942187, 965587, 665491, 558221,
 155005, 542804, 374792, 861217, 494707, 130934, 149152, 519475, 246459,  62935, 574586,
 212466, 325427, 508702, 183232, 688421, 124646, 896263, 787323, 266438, 795559, 762580,
 244581, 731328,  75274, 656248, 957074, 411579,  89987, 706328, 413738, 147943, 316935,
 781231, 318182, 908560, 946633, 962720,  10331, 943295, 946714, 431202, 946430, 532804,
  64672, 347847, 169484, 318533, 414566, 342734, 483389, 602875, 590032, 678593, 919015,
 812302, 406968, 104228, 135654, 752860, 466677, 971481, 862457, 646281, 922418, 324737,
 783453, 878959, 976978, 672974, 793102, 980230, 162838, 857389,  79981, 155814, 191597,
 809155, 460397, 847666, 410569, 471778, 907572, 578020, 713186, 603563, 408042, 411719,
 450312,   4886, 817086, 148953, 766485, 812276,  25987,  84414,  97261, 209191, 334297,
  93904, 515525, 437107, 804176, 687561, 383258, 228499, 434872, 708381, 527391, 321854,
 184704, 601790, 545414, 214622,  36166, 768849, 424828,  21571, 725912, 493516, 220130,
 639872, 576571, 204631, 467767, 575413, 175137, 256509, 653028, 923693, 142296, 172520,
 982522, 606641, 728483, 215817, 267804, 391485, 332856, 713806, 748227, 822663, 351791,
 110357, 122721,  27338, 124254, 992306, 457522, 266646, 177354, 805830,   4903, 397247,
  30329, 394556,  35653, 251495, 228713, 194516, 964076,  56866, 797336, 397840,  28105,
 487546, 762653, 687981, 273784, 353023, 807867, 536879, 550426, 427368, 310618, 206263,
 621464, 823010, 472692, 238082, 527322, 289654, 535419, 956896, 748788, 644454, 227163,
 931827, 618679, 615528, 804281, 965345, 949888, 247221, 989061, 167682, 216021, 759089,
 904226,  64768, 964348, 203687, 166605, 974695, 689858, 667033, 235467,  80185, 549303,
 184446, 427254, 296746, 442415, 718697, 171878,  91454, 742541, 592576, 544018, 773392,
 594136,  46057, 831747, 260088, 274934, 781064, 692328, 465117, 274031, 955895, 806171,
 956672, 126879, 268547, 772445, 576363, 598989, 212567, 327911, 576985, 110589, 945647,
 445153, 153929, 525430, 653160, 206131, 415747, 900991, 830513, 653088, 687613, 284954,
  44357, 521819,  35204, 701947, 422771, 196051, 428208, 588984,  68803, 353939,  90631,
 411509, 903344,  74359, 607980, 801243,  10612, 414616, 425434, 758244, 683411, 419285,
  95393, 529360,  88930,   2356, 223530, 397689, 808238, 367380, 609969, 559502, 577030,
 325259, 670876, 398533, 409209, 243781, 990654, 170483, 290991, 315039, 561418,  56336,
 895917, 836480, 340994, 767969,  13879, 891960, 691487,  22348, 937049,  63090, 702074,
 380565, 511362, 382664, 175024, 910425, 520384,  43740, 871885, 548378, 725926, 698661,
 437900, 437103, 947892, 200507, 329913, 996310, 627849, 758054, 892665, 395981, 473210,
 426809,  75974,  14395,  77535, 258507, 908309, 626924, 962260, 916795, 180407, 900730,
 841714, 438475, 678006, 494335, 931245, 259093, 984096, 668924, 848912, 357555, 234995,
 759919, 369872, 456540, 338472, 816289, 186947, 886942,  28676, 572829, 834924, 500473,
 703583, 610839, 235430, 162731, 205686, 143454, 690938, 152246, 908614, 390993, 989381,
 582947, 506863, 696296, 556692, 917816, 506424, 483311, 686010, 664397, 367291,  87929,
 218057, 616043, 775914, 524357, 644044, 858769, 423528, 510618, 806936, 331504, 699648,
 324723, 295800, 334114, 104090, 214690, 513435, 366037, 311964, 382628, 605039, 514397,
 545478, 197993, 763320, 925059, 510023, 900686, 255783, 907380, 442056, 153650, 789236,
 455289, 831202, 919953, 965759, 212441, 262480, 160872, 136043, 766661, 586801, 382700,
 680665, 324201,  95441, 661670, 993011, 585862, 963420, 130298, 131913, 781871, 534414,
 260556, 879155, 846947, 986886, 466379, 827995, 497438, 762030, 708197, 294282, 403336,
  64207, 946785, 954485, 438759, 604506, 753137, 686050, 607140, 391009, 812245, 460087,
 312798, 628746, 400859, 834657, 886944, 910286, 478389, 694916, 628914, 346162, 892962,
 221538, 980863, 993912, 661551, 299594, 963502, 914824, 302679, 659983, 740096, 739489,
 124349, 128283, 369163, 798805, 691885, 972115, 860922,    791, 633031, 480768, 776893,
 209452, 819875, 852946, 745046, 762511, 849656, 671754, 370883, 474084, 629527, 889793,
 395084, 381438, 524764, 523858, 599035, 120274, 976735, 517750, 406346,  26923, 339114,
 329577, 670275, 739063, 668223, 293854, 455734, 164567,  69429, 284061, 934099, 884282,
 567720, 772704,  23666, 781205, 688796, 718904, 517791, 334257, 506456, 157009, 468531,
 791916, 121735, 240165, 649014, 471727, 123626, 283812, 864479, 862562,  24924, 125113,
 920314, 645703, 363737, 432972, 931120, 987452, 645282, 964770, 386828, 498938, 748866,
 228001, 821460, 965897, 738346, 674292, 242777, 164709, 256195, 300546, 343397, 792153,
 739694, 769439, 955522,  37567, 922386, 520548, 951941, 415642, 199290, 101140,   3862,
 745472, 522509, 560233, 370474, 864433, 520999, 243259,  11171, 177714, 219075, 177644,
 244098, 727480, 566870, 300581,  52218, 388893, 286777, 796003, 839541, 222490, 277328,
 556202, 124647, 259824, 150492, 201283,  74036, 826232, 454913, 592849, 145986, 389753,
 832346, 140249, 662256, 211836, 193371, 168300, 249310, 508484, 567066, 443959, 893082,
 530844, 261583, 279468, 633366,  81729, 440848, 962812,  22917, 206334, 833425,  74546,
 110481, 398082, 352733,  59644,  48722, 758535, 108938,  55913,  55293,  61248, 995608,
 409930, 810100, 386284, 470775, 847646,  31355, 668414, 411266, 783438, 186068, 342366 };
