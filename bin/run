#!/bin/bash

if [[ $# -lt 1 ]]; then
  echo "Usage: bin/run [spec|cli]"
  exit 1
fi

PLATFORM="LINUX"
DEFAULT_FLAGS="-std=c11 -Wall -Werror"

if [[ $1 == "spec" ]]; then
  SPECS=$(find app/spec/specs/ -name "*.c" -type f | tr '\n' ' ')
  FILES="app/spec/main.c app/spec/containers.c $SPECS"

  if [ $# -eq 1 ]; then
    gcc $FILES                    \
      -no-integrated-cpp -B ./bin \
      $DEFAULT_FLAGS              \
      -D PLATFORM=$PLATFORM       \
      -I ./src                    \
      -g3 -o exe/spec

    if [ $? -ne 0 ]; then
      exit 1
    fi

    valgrind                    \
      --track-origins=yes       \
      --leak-check=full         \
      --show-leak-kinds=all     \
      exe/spec
    echo

  elif [[ $2 == "prep" ]]; then
    gcc $FILES                    \
      $DEFAULT_FLAGS              \
      -D PLATFORM=$PLATFORM       \
      -I ./src                    \
      -E | bin/inflect > tmp/spec.c

  elif [[ $2 == "debug" ]]; then
    gdb --args exe/spec ${@:2}

  else
    echo "Usage: bin/run spec [debug]"
    exit 1
  fi

elif [[ $1 == "cli" ]]; then

  if [[ $2 == "build" ]]; then
    FILES="app/cli/main.c app/cli/cli.c"

    gcc $FILES                    \
      -no-integrated-cpp -B ./bin \
      $DEFAULT_FLAGS              \
      -D PLATFORM=$PLATFORM       \
      -I ./src                    \
      -g3 -o exe/cli

    if [ $? -ne 0 ]; then
      exit 1
    fi

  elif [[ $2 == "debug" ]]; then
    gdb --args exe/cli ${@:2}

  else
    echo "Usage: bin/run cli [build|debug]"
    exit 1
  fi
fi
