#!/bin/bash

mkdir -p exe
mkdir -p tmp

if [ $# -lt 1 ]; then
  echo "Specify a source to compile."
  exit 1
fi

DEFAULT_FLAGS="-std=c2x -Wall -Werror -DPLATFORM=LINUX"


if [[ $1 == "spec" ]]; then
  BASE_FILES="src/spec.c src/ion/libraries.c"
  EXTRA_FILES=$(find src/spec/*.c -type f | tr '\n' ' ')
elif [[ $1 == "ion" ]]; then
  BASE_FILES="src/ion.c"
  EXTRA_FILES=""
else
  echo "Usage: bin/compile [ion|spec]"
  exit 1
fi

gcc $BASE_FILES $DEFAULT_FLAGS -E > tmp/$1.prep.c
if [ $? -ne 0 ]; then
  exit 1
fi

cat tmp/$1.prep.c | python3 bin/ion.py > tmp/$1.c
if [ $? -ne 0 ]; then
  exit 1
fi

gcc tmp/$1.c $EXTRA_FILES -include src/ion.h $DEFAULT_FLAGS ${@:2}
if [ $? -ne 0 ]; then
  exit 1
fi

rm -f tmp/$1.prep.c
rm -f tmp/$1.c
