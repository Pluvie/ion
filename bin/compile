#!/bin/bash

mkdir -p exe
mkdir -p tmp

if [ "$#" -lt 1 ]; then
    echo "Specify a source to compile."
    exit -1
fi

DEFAULT_FLAGS="-std=c2x -Wall -Werror -DPLATFORM=LINUX"

gcc src/$1.c $DEFAULT_FLAGS -E > tmp/$1.prep.c
if [ $? -ne 0 ]; then
  exit 1
fi

cat tmp/$1.prep.c | python3 bin/ion.py > tmp/$1.c
if [ $? -ne 0 ]; then
  exit 1
fi

gcc tmp/$1.c $DEFAULT_FLAGS ${@:2}
if [ $? -ne 0 ]; then
  exit 1
fi

rm -f tmp/$1.prep.c
rm -f tmp/$1.c
